<form>
  <label>Simulation Runner</label>
  <description>Takes query parameters and runs a simulation</description>
  <fieldset submitButton="true" autoRun="false">
    <input type="text" token="tech_name" searchWhenChanged="false">
      <label>Technique Name</label>
    </input>
    <input type="text" token="test_id">
      <label>Technique ID</label>
    </input>
    <input type="text" token="tech_test_nums">
      <label>Technique Test Numbers</label>
      <default>0</default>
      <initialValue>0</initialValue>
    </input>
    <input type="dropdown" token="ansible_awx_url">
      <label>Ansible AWX Server</label>
      <fieldForLabel>server</fieldForLabel>
      <fieldForValue>server_url</fieldForValue>
      <search>
        <query>|inputlookup ansible_servers</query>
      </search>
    </input>
    <input type="dropdown" token="ansible_awx_template">
      <label>Ansible AWX Template</label>
      <fieldForLabel>template</fieldForLabel>
      <fieldForValue>template</fieldForValue>
      <search>
        <query>|inputlookup ansible_templates</query>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </search>
    </input>
    <input type="dropdown" token="ansible_awx_target" searchWhenChanged="false">
      <label>Ansible AWX Limit</label>
      <search>
        <query>|inputlookup attck_assets</query>
        <earliest>-15m</earliest>
        <latest>now</latest>
      </search>
      <fieldForLabel>hostname</fieldForLabel>
      <fieldForValue>hostname</fieldForValue>
    </input>
    <input type="dropdown" token="ansible_awx_user">
      <label>AWX Account Username</label>
      <fieldForLabel>title</fieldForLabel>
      <fieldForValue>title</fieldForValue>
      <search>
        <query>| rest /servicesNS/nobody/TA-ansible-invoke/TA_ansible_invoke_account | table title</query>
      </search>
    </input>
    <input type="dropdown" token="splunk_hec_url">
      <label>Splunk HEC Server</label>
      <fieldForLabel>server</fieldForLabel>
      <fieldForValue>server_url</fieldForValue>
      <search>
        <query>|inputlookup splunk_hec_servers</query>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </search>
    </input>
    <input type="dropdown" token="splunk_hec_user">
      <label>Splunk HEC Username</label>
      <fieldForLabel>title</fieldForLabel>
      <fieldForValue>title</fieldForValue>
      <search>
        <query>| rest /servicesNS/nobody/TA-ansible-invoke/TA_ansible_invoke_account | table title</query>
      </search>
    </input>
    <input type="dropdown" token="detectionSearch" searchWhenChanged="true">
      <label>Saved Search for Detection</label>
      <fieldForLabel>title</fieldForLabel>
      <fieldForValue>search</fieldForValue>
      <search>
        <query>| rest /services/saved/searches | search title="[T*" | dedup title search | table title, description, search</query>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </search>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>Task Request ID</title>
      <table>
        <search>
          <finalized>
            <set token="search_id">$result.info_sid$</set>
            <set token="request_payload">$result.request_payload$</set>
          </finalized>
          <progress>
            <unset token="request_id"></unset>
          </progress>
          <done>
            <set token="request_id">$result.request_id$</set>
          </done>
          <query>|  makeresults
| eval request_id=tostring(random())
| eval test_id="$test_id$", tech_test_nums="$tech_test_nums$",ansible_awx_user="$ansible_awx_user$",ansible_awx_template="$ansible_awx_template$",ansible_awx_target="$ansible_awx_target$",ansible_awx_url="$ansible_awx_url$", splunk_hec_url="$splunk_hec_url$", splunk_hec_user="$splunk_hec_user$"
| fields request_id</query>
          <earliest>-1m@m</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <fields>["request_id"]</fields>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Atomic Execution (Wait for completion)</title>
      <table>
        <search id="AdvSim_test_event">
          <finalized>
            <set token="search_id">$result.info_sid$</set>
            <set token="request_payload">$result.request_payload$</set>
          </finalized>
          <progress>
            <unset token="NOOP_1"></unset>
          </progress>
          <done>
            <set token="NOOP_1">noop</set>
          </done>
          <query>|  makeresults
| eval target="$ansible_awx_target$"
| eval action="run"
| eval dest="$ansible_awx_target$"
| eval technique_name="$tech_name$"
| eval technique_id="$test_id$"
| eval technique_test_nums="$tech_test_nums$"
| eval request_id="$request_id$"
| eval playbook_name="$ansible_awx_template$"
| eval ansible_server="$ansible_awx_url$"
| eval awx_ansible_user="$ansible_awx_user$"
| sendalert ansible_invoke param.request_id="$request_id$" param.technique_id="$test_id$" param.technique_test_numbers="$tech_test_nums$" param.ansible_awx_user="$ansible_awx_user$" param.ansible_awx_template="$ansible_awx_template$" param.ansible_awx_target="$ansible_awx_target$" param.ansible_awx_url="$ansible_awx_url$" param.splunk_hec_url="$splunk_hec_url$" param.splunk_hec_user="$splunk_hec_user$"</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <fields>["target","action","ansible_server","playbook_name","request_id"]</fields>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Atomic Result</title>
      <table>
        <search>
          <query>index=main source="splunk:redteam" RequestID="$request_id$" | table "Execution*", "GUID", "Hostname", "RequestID", "Technique", "Test Name", "Test Number", "Username" | $NOOP_1$</query>
          <earliest>-10m</earliest>
          <latest>now</latest>
          <refresh>30s</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row>
    <panel depends="detectionSearch">
      <title>Detection Search Panel</title>
      <input type="radio" token="search_hit" searchWhenChanged="true">
        <label>Detection Search Fired?</label>
        <choice value="-1">Needs Data</choice>
        <choice value="0">Have Data; Not Detected</choice>
        <choice value="1">Detection for single sub-technique</choice>
        <choice value="2">Detection for multiple sub-techniques</choice>
        <choice value="3">Active Correlation rule(s) in place</choice>
        <choice value="4">Highest confidence</choice>
      </input>
      <html>
        <p>
          Use these radio buttons to select whether the detection search you selected at the top actually fired during the test time and detected the activity you were testing.  Selecting an option will update the MITRE ATT&amp;CK Nav display layer.
        </p>
      </html>
      <table>
        <title>$detectionSearch$ | $NOOP_1$</title>
        <search>
          <query>$detectionSearch$ 
| fields * | $NOOP_1$</query>
          <earliest>-30m@m</earliest>
          <latest>now</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row>
    <panel depends="search_hit">
      <title>Update ATTCK Board</title>
      <event>
        <search>
          <query>| makeresults 1 | eval technique="$test_id$" | eval detected=$search_hit$ | genatklayer atkfield=technique </query>
          <earliest>-60m@m</earliest>
          <latest>now</latest>
        </search>
        <option name="count">5</option>
        <option name="list.drilldown">none</option>
        <option name="list.wrap">1</option>
        <option name="maxLines">5</option>
        <option name="raw.drilldown">full</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">0</option>
        <option name="table.drilldown">all</option>
        <option name="table.sortDirection">desc</option>
        <option name="table.wrap">1</option>
        <option name="type">list</option>
      </event>
    </panel>
  </row>
</form>